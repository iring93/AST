<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>模擬OO醫院AEROBIC GRAM NEGATIVE微生物抗生素感受性報表</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
  <div class="max-w-screen-2xl w-full mx-auto py-8 px-4">
    <h1 class="text-xl font-semibold text-slate-800 mb-2">模擬OO醫院AEROBIC GRAM NEGATIVE微生物抗生素感受性報表</h1>
    <p class="text-slate-600 text-sm mb-4">使用說明：+/- 可展開，基於13,278筆檢驗結果 (包含GNB、GNB-NF及GNC)</p>
    <div id="root"></div>
  </div>

  <script type="text/babel" data-presets="react">
    /** Utils **/
    const byId = (arr, key='id') => Object.fromEntries(arr.map(x => [x[key] || x.microbe_name, x]));

    function normalizeClass(s) {
      return String(s || "").replace(/\.(d+)$/, "");
    }
    function clamp(n, a=0, b=100){ return Math.max(a, Math.min(b, n)); }

    /** 判斷是否為 S：優先用分類（cat[row][abx] = 'S'|'I'|'R'）；否則以 %S >= thresholdS 視為 S **/
    function makeIsSGetter({data, cat, thresholdS=80}){
      return (rowKey, abxShort)=>{
        const label = cat?.[rowKey]?.[abxShort];
        if (label) return label.toUpperCase()==='S';
        const pct = data?.[rowKey]?.[abxShort];
        if (typeof pct === 'number') return pct >= thresholdS;
        return false;
      };
    }

    /** 計算父層平均：不加權、只取有值子列；若父層自身有值，優先顯示自身值 **/
    function computeParentAverage(rowKey, abxShort, childrenRowKeys, data) {
      const self = data?.[rowKey]?.[abxShort];
      if (typeof self === 'number') return self; // 有原始值就用它
      let sum = 0, cnt = 0;
      for (const ck of childrenRowKeys) {
        const v = data?.[ck]?.[abxShort];
        if (typeof v === 'number') { sum += v; cnt++; }
      }
      if (cnt === 0) return null;
      return Math.round(sum / cnt);
    }

    /** 建立階層（支持 1~3 層）：回傳 {nodes, childrenBy, categories} **/
    function buildHierarchy({ microbes, data, cat, antibiotics, sortAlphabetically = false }){
      const isS = makeIsSGetter({data, cat, thresholdS:80});

      const nodes = [];               // 所有節點（按顯示層級順序）
      const childrenBy = {};         // childrenBy[parentKey] = [childNodes...]
      const categories = {};         // 類別（GNB/GNB-NF/GNC）做為最外層
      const reg = {
        acinetobacter: /^Acinetobacter(\b|\s)/i,
        klebsiella: /^Klebsiella(\b|\s)/i,
        enterobacter: /^Enterobacter(\b|\s)/i
      };

      // 先依名稱快速索引
      const mIndex = byId(microbes, 'id');
      const byName = Object.fromEntries(microbes.map(m => [m.microbe_name, m]));

      /** 建 category helper **/
      function ensureCategory(catLabel){
        const key = "__CAT__" + catLabel;
        if (!categories[key]) {
          const n = { id:key, microbe_name:catLabel, _type:'category' };
          nodes.push(n);
          categories[key] = n;
        }
        return categories[key];
      }
      function addChild(p, c){
        const pk = p.id || p.microbe_name;
        (childrenBy[pk] ||= []).push(c);
      }

      function shortenGenus(fullName) {
        const parts = fullName.trim().split(/\s+/);
        if (parts.length >= 2) {
          const genus = parts[0];
          const species = parts.slice(1).join(" ");
          return genus.charAt(0) + ". " + species;
        }
        return fullName; // fallback: 如果只有一個字就原樣返回
      }

      /** 1) GNB → Escherichia coli → non-CR E. coli / CR E. coli **/
      (function(){
        const catNode = ensureCategory("GNB");
        const parent = byName["Escherichia coli"]; 
        if (!parent) return;

        // 父層保留完整名稱
        nodes.push(parent); 
        addChild(catNode, parent);

        const pid = parent.id || parent.microbe_name;
        const short = shortenGenus(parent.microbe_name);

        // 判斷：IPM + MEM + ETP 皆 S → non-CR，否則 CR
        const allS = isS(pid, "IPM") && isS(pid, "MEM") && isS(pid, "ETP");

        const non = { 
          id: pid + "_nonCREC", 
          microbe_name: `${short} — non-CR E. coli`, 
          _virtual: true, 
          _active: allS, 
          _proxyRowKey: pid 
        };
        const cr  = { 
          id: pid + "_CREC",    
          microbe_name: `${short} — CR E. coli`, 
          _virtual: true, 
          _active: !allS, 
          _proxyRowKey: pid 
        };

        addChild(parent, non);
        addChild(parent, cr);
      })();

      /** 2) GNB → Klebsiella pneumoniae → non-CRKP / CRKP **/
      (function(){
        const catNode = ensureCategory("GNB");
        const parent = byName["Klebsiella pneumoniae"]; 
        if (!parent) return;

        // 父層保留完整名稱
        nodes.push(parent); 
        addChild(catNode, parent);

        const pid = parent.id || parent.microbe_name;
        const short = shortenGenus(parent.microbe_name);

        // 判斷：IPM + MEM + ETP 皆 S → non-CRKP，否則 CRKP
        const allS = isS(pid, "IPM") && isS(pid, "MEM") && isS(pid, "ETP");

        const non = { 
          id: pid + "_nonCRKP", 
          microbe_name: `${short} — non-CRKP`, 
          _virtual: true, 
          _active: allS, 
          _proxyRowKey: pid 
        };
        const cr  = { 
          id: pid + "_CRKP",    
          microbe_name: `${short} — CRKP`, 
          _virtual: true, 
          _active: !allS, 
          _proxyRowKey: pid 
        };

        addChild(parent, non);
        addChild(parent, cr);
      })();

      /** 3) GNB-NF → Pseudomonas aeruginosa → Carbapenem & Fluoroquinolone 分支 **/
      (function(){
        const catNode = ensureCategory("GNB-NF");
        const parent = byName["Pseudomonas aeruginosa"];
        if (!parent) return;

        // ① 先把「Pseudomonas aeruginosa」掛成父層
        nodes.push(parent);
        addChild(catNode, parent);

        const pid = parent.id || parent.microbe_name;
        const paShort = shortenGenus(parent.microbe_name);

        // ── Carbapenem 分支父層 ──────────────────────────────────
        const paCarb = { id: "__P_PA_CARB__", microbe_name: paShort + " (Carbapenem)", _virtual: true };
        addChild(parent, paCarb);             // ★ 掛在「P. aeruginosa」底下（不是掛在分類底下）

        const carbBothS = isS(pid, "IPM") && isS(pid, "MEM"); // 兩者皆 S → non-CRPA
        const nonCRPA = {
          id: pid + "_nonCRPA",
          microbe_name: paShort + " — non-CRPA",
          _virtual: true,
          _active: carbBothS,
          _proxyRowKey: pid
        };
        const CRPA = {
          id: pid + "_CRPA",
          microbe_name: paShort + " — CRPA",
          _virtual: true,
          _active: !carbBothS,
          _proxyRowKey: pid
        };
        addChild(paCarb, nonCRPA);
        addChild(paCarb, CRPA);

        // ── Fluoroquinolone 分支父層 ──────────────────────────────
        const paFQ = { id: "__P_PA_FQ__", microbe_name: paShort + " (Fluoroquinolone)", _virtual: true };
        addChild(parent, paFQ);               // ★ 同樣掛在「P. aeruginosa」底下

        const fqBothS = isS(pid, "LVX") && isS(pid, "CIP");   // 兩者皆 S → non-QRDRs
        const nonQR = {
          id: pid + "_nonQRDRs",
          microbe_name: paShort + " — non-QRDRs",
          _virtual: true,
          _active: fqBothS,
          _proxyRowKey: pid
        };
        const QR = {
          id: pid + "_QRDRs",
          microbe_name: paShort + " — QRDRs",
          _virtual: true,
          _active: !fqBothS,
          _proxyRowKey: pid
        };
        addChild(paFQ, nonQR);
        addChild(paFQ, QR);
      })();

      /** 4) GNB-NF → Acinetobacter baumannii complex → 各物種 → non-CRAB/CRAB **/
      (function(){
        const catNode = ensureCategory("GNB-NF");
        const complex = { id:"__P_ACB_COMPLEX__", microbe_name:"Acinetobacter baumannii complex", _virtual:true };
        nodes.push(complex); 
        addChild(catNode, complex);

        // 指定的 Acinetobacter 物種
        const acbSpecies = ["Acinetobacter baumannii", "Acinetobacter nosocomialis"];
        const kids = microbes.filter(m => acbSpecies.includes(m.microbe_name));
        
        const sortedKids = sortAlphabetically 
          ? kids.sort((a, b) => a.microbe_name.localeCompare(b.microbe_name))
          : kids;
          
        sortedKids.forEach(k => {
          const shortName = shortenGenus(k.microbe_name);
          // 建立一個帶縮寫名稱的代理節點，但仍沿用原 id（避免數據斷掉）
          const kNode = { ...k, microbe_name: shortName };
          addChild(complex, kNode);
        });

        // 每個物種各自建立 non-CRAB 與 CRAB 兩個分支
        for (const k of kids) {
          const kId = k.id || k.microbe_name;

          // IPM 與 MEM 皆為 S → non-CRAB；否則 CRAB
          const bothS = isS(kId, "IPM") && isS(kId, "MEM");

          // 物種名稱縮寫（例如：Acinetobacter baumannii → A. baumannii）
          const shortName = shortenGenus(k.microbe_name);

          const non = { 
            id: kId + "_nonCRAB", 
            microbe_name: shortName + " — non-CRAB", 
            _virtual: true,
            _active: bothS,           // 被套用者
            _proxyRowKey: kId         // 取該物種自身的原始數據
          };

          const cr  = { 
            id: kId + "_CRAB",    
            microbe_name: shortName + " — CRAB", 
            _virtual: true,
            _active: !bothS,          // 未被套用者（在 valueForCell 會顯示 '-'）
            _proxyRowKey: kId
          };

          addChild(k, non);
          addChild(k, cr);
        }
      })();

      /** 5) GNB → 其他 Enterobacteriaceae **/
      (function(){
        const catNode = ensureCategory("GNB");
        const enterobacteriaceae = microbes.filter(m => 
          !m.microbe_name.includes("Escherichia coli") &&
          !m.microbe_name.includes("Klebsiella pneumoniae") &&
          (m.microbe_name.includes("Enterobacter") ||
           m.microbe_name.includes("Klebsiella") ||
           m.microbe_name.includes("Serratia") ||
           m.microbe_name.includes("Citrobacter") ||
           m.microbe_name.includes("Proteus") ||
           m.microbe_name.includes("Morganella"))
        );
        
        const sortedEnterobacteriaceae = sortAlphabetically 
          ? enterobacteriaceae.sort((a, b) => a.microbe_name.localeCompare(b.microbe_name))
          : enterobacteriaceae;
          
        sortedEnterobacteriaceae.forEach(e => {
          nodes.push(e);
          addChild(catNode, e);
        });
      })();

      /** 6) GNB-NF → 其他非發酵菌 **/
      (function(){
        const catNode = ensureCategory("GNB-NF");
        const nonFermenters = microbes.filter(m => 
          !m.microbe_name.includes("Pseudomonas aeruginosa") &&
          !m.microbe_name.includes("Acinetobacter baumannii") &&
          !m.microbe_name.includes("Acinetobacter nosocomialis") &&
          (m.microbe_name.includes("Stenotrophomonas") ||
           m.microbe_name.includes("Chryseobacterium") ||
           m.microbe_name.includes("Burkholderia") ||
           m.microbe_name.includes("Elizabethkingia") ||
           m.microbe_name.includes("Achromobacter") ||
           m.microbe_name.includes("Sphingomonas") ||
           m.microbe_name.includes("Ralstonia") ||
           m.microbe_name.includes("Acinetobacter"))
        );
        
        const sortedNonFermenters = sortAlphabetically 
          ? nonFermenters.sort((a, b) => a.microbe_name.localeCompare(b.microbe_name))
          : nonFermenters;
          
        sortedNonFermenters.forEach(nf => {
          nodes.push(nf);
          addChild(catNode, nf);
        });
      })();

      /** 7) GNC → 其他革蘭氏陰性球菌 **/
      (function(){
        const catNode = ensureCategory("GNC");
        const gnc = microbes.filter(m => 
          m.microbe_name.includes("Moraxella") ||
          m.microbe_name.includes("Haemophilus") ||
          m.microbe_name.includes("Neisseria") ||
          m.microbe_name.includes("Helicobacter")
        );
        
        const sortedGNC = sortAlphabetically 
          ? gnc.sort((a, b) => a.microbe_name.localeCompare(b.microbe_name))
          : gnc;
          
        sortedGNC.forEach(g => {
          nodes.push(g);
          addChild(catNode, g);
        });
      })();

      return { nodes, childrenBy, categories };
    }

    function ASTSusceptibilityTable({
      title = "模擬OO醫院 2024年 AEROBIC GRAM NEGATIVE 微生物抗生素感受性報表（基於13,278筆檢驗結果）",
      antibiotics = [],
      microbes = [],
      data = {},
      meta = {},
      cat = {},              // 可選：S/I/R 類別，若無則用 %S >= 80 判斷
      showOnlyWithData = true,
    }) {
      const [showAllAntibiotics, setShowAllAntibiotics] = React.useState(!showOnlyWithData);
      const [expanded, setExpanded] = React.useState({}); // 展開狀態：key:boolean
      const [sortAlphabetically, setSortAlphabetically] = React.useState(false); // 字母排序
      const [showLowCountMicrobes, setShowLowCountMicrobes] = React.useState(true); // 顯示低菌株數微生物
      const minCoverage = 1;
      const minStrainCount = 20;

      const { nodes, childrenBy, categories } = React.useMemo(
        () => buildHierarchy({ microbes, data, cat, antibiotics, sortAlphabetically }),
        [microbes, data, cat, antibiotics, sortAlphabetically]
      );

      // 實際菌株數量對照表（基於CSV數據統計）
      const strainCounts = {
        "Escherichia coli": 3067,
        "Klebsiella pneumoniae": 2112,
        "Pseudomonas aeruginosa": 2028,
        "Stenotrophomonas maltophilia": 709,
        "Enterobacter cloacae complex": 478,
        "Acinetobacter baumannii": 471,
        "Proteus mirabilis": 459,
        "Acinetobacter nosocomialis": 307,
        "Serratia marcescens": 294,
        "Chryseobacterium indologenes": 256,
        "Burkholderia cepacia complex": 250,
        "Klebsiella aerogenes (Enterobacter aerogenes)": 179,
        "Moraxella catarrhalis (Moraxella_sg_Branhamella catarrhalis)": 177,
        "Citrobacter koseri": 146,
        "Haemophilus influenzae": 136,
        "Morganella morganii": 125,
        "Elizabethkingia anophelis": 116,
        "Klebsiella oxytoca": 102
      };

      function getStrainCount(microbeName) {
        return strainCounts[microbeName] || 0;
      }

      // 預設將第 1 層（分類）與第 2 層（父層）打開
      React.useEffect(() => {
        const next = {};
        for (const n of nodes) {
          if (n._type === 'category') next[n.id] = true;
          const k = n.id || n.microbe_name;
          if (childrenBy[k]?.length) next[k] = true;
        }
        setExpanded(next);
      }, [nodes, childrenBy]);

      function getChildrenKeys(parent){
        const pk = parent.id || parent.microbe_name;
        return (childrenBy[pk] || []).map(n => n.id || n.microbe_name);
      }

      // 依展開狀態攤平成可見列，並根據菌株數篩選
      const visibleRows = [];
      const seen = new Set();
      function pushNode(n, level){
        const key = n.id || n.microbe_name;
        const strainCount = getStrainCount(n.microbe_name);
        
        // 如果設定隱藏低菌株數且不是分類節點，檢查菌株數
        if (!showLowCountMicrobes && n._type !== 'category' && !n._virtual && strainCount < minStrainCount) {
          return; // 跳過這個節點
        }
        
        visibleRows.push({ ...n, _level: level, _hasChildren: (childrenBy[key]?.length || 0) > 0 });
        if (expanded[key]) {
          for (const c of (childrenBy[key] || [])) pushNode(c, level+1);
        }
      }
      // 根據 categories 的插入順序輸出
      Object.values(categories).forEach(catNode => pushNode(catNode, 0));

      // coverage
      const coverage = {};
      for (let i = 0; i < antibiotics.length; i++) {
        const short = antibiotics[i].anti_shortname;
        let cnt = 0;
        for (let r = 0; r < visibleRows.length; r++) {
          const rowKey = visibleRows[r].id || visibleRows[r].microbe_name;
          const val = data?.[rowKey]?.[short];
          if (typeof val === 'number') cnt++;
        }
        coverage[short] = cnt;
      }

      const visibleAntibiotics = showAllAntibiotics
        ? antibiotics
        : antibiotics.filter(a => (coverage[a.anti_shortname] || 0) >= minCoverage);
      const hiddenCount = antibiotics.length - visibleAntibiotics.length;

      const classGroups = React.useMemo(() => {
        const groups = [];
        let i = 0;
        while (i < visibleAntibiotics.length) {
          const clsDisp = normalizeClass(visibleAntibiotics[i].anti_class);
          let j = i + 1;
          while (j < visibleAntibiotics.length && normalizeClass(visibleAntibiotics[j].anti_class) === clsDisp) j++;
          groups.push({ anti_class: clsDisp, span: j - i });
          i = j;
        }
        return groups;
      }, [visibleAntibiotics]);

      const isGroupEnd = React.useMemo(() => {
        const ends = [];
        for (let i = 0; i < visibleAntibiotics.length; i++) {
          const cur = normalizeClass(visibleAntibiotics[i].anti_class);
          const nxt = i + 1 < visibleAntibiotics.length ? normalizeClass(visibleAntibiotics[i + 1].anti_class) : null;
          ends.push(cur !== nxt);
        }
        return ends;
      }, [visibleAntibiotics]);

      function toggleRow(n){
        const key = n.id || n.microbe_name;
        setExpanded(prev => ({ ...prev, [key]: !prev[key] }));
      }

      function valueForCell(row, aShort){
        const rowKey = row.id || row.microbe_name;
        const direct = data?.[rowKey]?.[aShort];
        if (typeof direct === 'number') return direct;
        if (row._hasChildren) {
          const childKeys = getChildrenKeys(row);
          const avg = computeParentAverage(rowKey, aShort, childKeys, data);
          return typeof avg === 'number' ? avg : null;
        }
        return null;
      }

      function tooltip(a, row) {
        const rowKey = row.id || row.microbe_name;
        const val = valueForCell(row, a.anti_shortname);
        
        if (typeof data?.[rowKey]?.[a.anti_shortname] === 'number') {
          // 原始數據
          const percentS = data[rowKey][a.anti_shortname];
          const totalStrains = getStrainCount(row.microbe_name);
          const sensitiveStrains = Math.round(totalStrains * percentS / 100);
          
          return `抗生素: ${a.anti_name || a.anti_shortname}\n微生物: ${row.microbe_name}\n檢驗菌株數: ${totalStrains}\n感受性 S菌株數: ${sensitiveStrains}\n感受性百分比: ${percentS}%`;
        }
        
        if (row._hasChildren && typeof val === 'number') {
          // 父層平均值 - 顯示計算來源
          const childKeys = getChildrenKeys(row);
          const childStrains = childKeys.map(k => {
            const childName = nodes.find(n => (n.id || n.microbe_name) === k)?.microbe_name;
            return getStrainCount(childName) || 0;
          });
          const totalStrains = childStrains.reduce((sum, count) => sum + count, 0);
          const sensitiveStrains = Math.round(totalStrains * val / 100);
          
          return `抗生素: ${a.anti_name || a.anti_shortname}\n微生物: ${row.microbe_name}\n總檢驗菌株數: ${totalStrains}\n感受性 S菌株數: ${sensitiveStrains}\n感受性百分比: ${val}%`;
        }
        
        return `抗生素: ${a.anti_name || a.anti_shortname}\n微生物: ${row.microbe_name}\n檢驗菌株數: -\n感受性 S菌株數: -`;
      }

      const hasData = visibleRows.length > 0 && visibleAntibiotics.length > 0;

      function bgByLevel(depth, isCategory) {
        if (isCategory) return "bg-slate-100"; // 分類列(GNB/GNB-NF/GNC)
        if (depth === 1) return "bg-slate-50";     // 父層
        if (depth === 2) return "bg-slate-50/40";  // 子層
        return "bg-slate-100/50";               // 次子層(或更深)
      }

      return (
        <div className="p-6 bg-white rounded-2xl shadow">
          <div className="mb-3 flex items-center justify-between">
            <div>
              <div className="text-sm font-medium text-slate-800">{title}</div>
              <div className="text-xs text-slate-500">分母：分析之菌種/屬及抗生素項目組合有藥敏試驗結果之菌株數。 分子：分母中抗生素藥敏試驗結果為 S 之菌株數。敏感性百分比 = 分子/分母*100%。</div>
            </div>
            <div className="text-xs text-slate-600">
              可見抗生素：<span className="font-medium text-slate-800">{visibleAntibiotics.length}</span> / {antibiotics.length}
              {hiddenCount > 0 && <span className="ml-1 text-slate-400">（隱藏 {hiddenCount}）</span>}
              <button
                type="button"
                onClick={() => setShowAllAntibiotics(v => !v)}
                className="ml-3 rounded-lg border border-slate-200 bg-white px-2.5 py-1 hover:bg-slate-50"
              >
                {showAllAntibiotics ? "只顯示有數據" : "顯示全部抗生素"}
              </button>
              <button
                type="button"
                onClick={() => setShowLowCountMicrobes(v => !v)}
                className="ml-2 rounded-lg border border-slate-200 bg-white px-2.5 py-1 hover:bg-slate-50"
              >
                {showLowCountMicrobes ? "隱藏檢驗菌株數<20株" : "顯示全部微生物"}
              </button>
              <button
                type="button"
                onClick={() => setSortAlphabetically(v => !v)}
                className="ml-2 rounded-lg border border-slate-200 bg-white px-2.5 py-1 hover:bg-slate-50"
              >
                {sortAlphabetically ? "預設排序" : "字母排序"}
              </button>
            </div>
          </div>

          {!hasData ? (
            <div className="rounded-xl border border-dashed border-slate-200 p-6 text-center text-slate-500">尚未載入資料。</div>
          ) : (
            <div className="overflow-x-auto w-full">
              <table className="min-w-[1400px] w-full border-separate border-spacing-0 text-sm text-center">
                <thead>
                  <tr>
                    <th className="sticky left-0 z-10 border-b border-slate-200 bg-white px-3 py-1 text-left text-xs font-medium text-slate-600" rowSpan={2}>分類 / 微生物名稱</th>
                    {classGroups.map((g, idx) => (
                      <th key={idx} className="border-b border-slate-200 bg-slate-50 px-3 py-1 text-center text-[11px] font-medium text-slate-700" colSpan={g.span}>
                        {g.anti_class}
                      </th>
                    ))}
                  </tr>
                  <tr>
                    {visibleAntibiotics.map((a, idx) => (
                      <th
                        key={idx}
                        className={"border-b border-slate-200 bg-white px-3 py-2 text-center align-bottom " + (isGroupEnd[idx] ? "border-r-4 border-r-slate-300" : "")}
                        title={a.anti_name}
                      >
                        <span className="text-xs font-medium text-slate-800">{a.anti_shortname}</span>
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {visibleRows.map((m) => {
                    const key = m.id || m.microbe_name;
                    const depth = m._level || 0;
                    const hasChildren = !!m._hasChildren;
                    const isCategory = m._type === 'category';
                    return (
                      <tr key={key} className={`${bgByLevel(depth, isCategory)} hover:bg-slate-50/60`}>
                        <td className={"sticky left-0 z-0 px-3 py-2 text-sm " + (isCategory ? "font-semibold text-slate-700 bg-slate-100" : "text-slate-800 bg-white")}>
                          <div className="flex items-center gap-2">
                            {hasChildren ? (
                              <button
                                type="button"
                                onClick={() => toggleRow(m)}
                                className={"mr-1 h-5 w-5 rounded border border-slate-300 text-xs leading-4 " + (expanded[key] ? "bg-slate-600 text-white border-slate-600" : "bg-white")}
                                title={expanded[key] ? "收合" : "展開"}
                              >
                                {expanded[key] ? "−" : "+"}
                              </button>
                            ) : (
                              <span className="mr-6" />
                            )}

                            {/* 這個 span 做縮排＆導引線 */}
                            <span
                              style={{
                                paddingLeft: Math.max(0, depth - 1) * 12,          // 縮排
                                borderLeft: depth > 1 ? "2px solid #cbd5e1" : "0", // 導引線（slate-300）
                              }}
                              className={
                                depth === 0 ? "font-bold text-slate-800" :
                                depth === 1 ? "font-semibold text-slate-700" :
                                "text-slate-600 text-sm"
                              }
                            >
                              {m.microbe_name}
                              {!isCategory && !m._virtual && (
                                <span className="ml-2 text-xs text-slate-400">
                                  ({getStrainCount(m.microbe_name)}株)
                                </span>
                              )}
                            </span>
                          </div>
                        </td>
                          
                        {visibleAntibiotics.map((a, cIdx) => {
                          const v = valueForCell(m, a.anti_shortname);
                          const display = (typeof v === 'number') ? `${clamp(v)}%` : "-";
                          const quality = (typeof v === 'number') ? (v >= 80 ? "good" : v >= 60 ? "warn" : "bad") : "na";
                          return (
                            <td key={cIdx} className={"px-3 py-2 text-sm text-center " + (isGroupEnd[cIdx] ? "border-r-4 border-r-slate-200" : "")}>
                              <span
                                className={
                                  quality === "good" ? "rounded-md bg-emerald-50 px-2 py-0.5 text-emerald-700" :
                                  quality === "warn" ? "rounded-md bg-amber-50 px-2 py-0.5 text-amber-700" :
                                  quality === "bad" ? "rounded-md bg-rose-50 px-2 py-0.5 text-rose-700" :
                                  "text-slate-500"
                                }
                                title={tooltip(a, m)}
                              >
                                {display}
                              </span>
                            </td>
                          );
                        })}
                      </tr>
                    );
                  })}
                </tbody>
              </table>
              <div className="mt-3 text-xs text-slate-500">~~~測試測試測試~~~ (總計13,278筆GNB檢驗結果)</div>
            </div>
          )}
        </div>
      );
    }

    /*****************
     * 真實測試資料區    *
     *****************/
    const antibioticsFromExcel = [
      { anti_class: "Penicillin Group", anti_shortname: "P", anti_name: "Penicillin G" },
      { anti_class: "Penicillin Group", anti_shortname: "AM", anti_name: "Ampicillin" },
      { anti_class: "Penicillin Group", anti_shortname: "AMC", anti_name: "Amoxicillin/Clavulanate" },
      { anti_class: "Penicillin Group", anti_shortname: "OX", anti_name: "Oxacillin" },
      { anti_class: "Penicillin Group", anti_shortname: "SAM", anti_name: "Ampicillin/Sulbactam" },
      { anti_class: "Cephalosporin Group 1st", anti_shortname: "CZ(O)", anti_name: "Cefazolin other" },
      { anti_class: "Cephalosporin Group 1st", anti_shortname: "CZ(U)", anti_name: "Cefazolin Urine" },
      { anti_class: "Cephalosporin Group 2nd", anti_shortname: "CMZ", anti_name: "Cefmetazole" },
      { anti_class: "Cephalosporin Group 2nd", anti_shortname: "CXM", anti_name: "Cefuroxime" },
      { anti_class: "Cephalosporin Group 3rd", anti_shortname: "CAZ", anti_name: "Ceftazidime" },
      { anti_class: "Cephalosporin Group 3rd", anti_shortname: "CTX", anti_name: "Cefotaxime" },
      { anti_class: "Cephalosporin Group 3rd", anti_shortname: "CRO", anti_name: "Ceftriaxone" },
      { anti_class: "Cephalosporin Group 3rd", anti_shortname: "CFM", anti_name: "Cefixime" },
      { anti_class: "Cephalosporin Group 3rd", anti_shortname: "CPD", anti_name: "Cefpodoxime" },
      { anti_class: "Cephalosporin Group 4th", anti_shortname: "FEP", anti_name: "Cefepime" },
      { anti_class: "Carbapenem Group", anti_shortname: "IPM", anti_name: "Imipenem" },
      { anti_class: "Carbapenem Group", anti_shortname: "MEM", anti_name: "Meropenem" },
      { anti_class: "Carbapenem Group", anti_shortname: "ETP", anti_name: "Ertapenem" },
      { anti_class: "Other β-Lactam", anti_shortname: "TZP", anti_name: "Piperacillin/Tazobactam" },
      { anti_class: "Other β-Lactam", anti_shortname: "CZA", anti_name: "Ceftazidime/Avibactam" },
      { anti_class: "Other β-Lactam", anti_shortname: "CTT", anti_name: "Ceftolozane/Tazobactam" },
      { anti_class: "Oxacephem", anti_shortname: "FLO", anti_name: "Flomoxef" },
      { anti_class: "Aminoglycosides", anti_shortname: "AN", anti_name: "Amikacin" },
      { anti_class: "Aminoglycosides", anti_shortname: "AN(U)", anti_name: "Amikacin urine" },
      { anti_class: "Aminoglycosides", anti_shortname: "GM", anti_name: "Gentamicin 10μg" },
      { anti_class: "Aminoglycosides", anti_shortname: "GMh", anti_name: "Gentamicin 120μg" },
      { anti_class: "Fluoroquinolones", anti_shortname: "CIP", anti_name: "Ciprofloxacin" },
      { anti_class: "Fluoroquinolones", anti_shortname: "LVX", anti_name: "Levofloxacin" },
      { anti_class: "Fluoroquinolones", anti_shortname: "MXF", anti_name: "Moxifloxacin" },
      { anti_class: "Tetracyclines", anti_shortname: "TE", anti_name: "Tetracycline" },
      { anti_class: "Tetracyclines", anti_shortname: "MI", anti_name: "Minocycline" },
      { anti_class: "Macrolides", anti_shortname: "E", anti_name: "Erythromycin" },
      { anti_class: "Lincosamides", anti_shortname: "CC", anti_name: "Clindamycin" },
      { anti_class: "Oxazolidinones", anti_shortname: "LZD", anti_name: "Linezolid" },
      { anti_class: "Chloramphenicol", anti_shortname: "C", anti_name: "Chloramphenicol" },
      { anti_class: "Glycopeptides", anti_shortname: "VA", anti_name: "Vancomycin" },
      { anti_class: "Cyclic Lipopeptides", anti_shortname: "DAP", anti_name: "Daptomycin" },
      { anti_class: "Glycylcyclines", anti_shortname: "TGC", anti_name: "Tigecycline" },
      { anti_class: "Polymyxins", anti_shortname: "CL", anti_name: "Colistin" },
      { anti_class: "Steroid Antibiotics", anti_shortname: "FA", anti_name: "Fusidic acid" },
      { anti_class: "Nitroimidazoles", anti_shortname: "MET", anti_name: "Metronidazole" },
      { anti_class: "Sulfonamide Combinations", anti_shortname: "SXT", anti_name: "Trimethoprim/Sulfamethoxazole" }
    ];


    const microbesFromTest = [
      // GNB - 腸桿菌科
      { id: "ECOLI", microbe_name: "Escherichia coli" },
      { id: "KPNEUMONIAE", microbe_name: "Klebsiella pneumoniae" },
      { id: "ENTCLOACAE", microbe_name: "Enterobacter cloacae complex" },
      { id: "PROTMIRABILIS", microbe_name: "Proteus mirabilis" },
      { id: "SERMARCESCENS", microbe_name: "Serratia marcescens" },
      { id: "KAEROGENES", microbe_name: "Klebsiella aerogenes (Enterobacter aerogenes)" },
      { id: "CITKOSERI", microbe_name: "Citrobacter koseri" },
      { id: "MORGMORGANII", microbe_name: "Morganella morganii" },
      { id: "KOXYTOCA", microbe_name: "Klebsiella oxytoca" },
      
      // GNB-NF - 非發酵菌
      { id: "PAER", microbe_name: "Pseudomonas aeruginosa" },
      { id: "ACBBAUMANNII", microbe_name: "Acinetobacter baumannii" },
      { id: "ACBNOSOCOMIALIS", microbe_name: "Acinetobacter nosocomialis" },
      { id: "STEMALTOPHILIA", microbe_name: "Stenotrophomonas maltophilia" },
      { id: "CHRYSINDOLOGENES", microbe_name: "Chryseobacterium indologenes" },
      { id: "BURKCOMPLEX", microbe_name: "Burkholderia cepacia complex" },
      { id: "ELIZANOPHELIS", microbe_name: "Elizabethkingia anophelis" },
      
      // GNC - 革蘭氏陰性球菌
      { id: "MORAXCATARRHALIS", microbe_name: "Moraxella catarrhalis (Moraxella_sg_Branhamella catarrhalis)" },
      { id: "HAEMINFLUENZAE", microbe_name: "Haemophilus influenzae" },
    ];

    // 真實測試資料：基於13278筆檢驗結果計算的感受性百分比
    const excelData = {
      // GNB - 腸桿菌科
      // Escherichia coli (3067株)
      ECOLI: { IPM: 98, MEM: 99, ETP: 97, CAZ: 74, CTX: 54, FEP: 84, TZP: 85, CZA: 79, CTT: 21, AN: 97, GM: 76, CIP: 54, LVX: 43, SXT: 45, TGC: 99, CL: 0, SAM: 35 },
      
      // Klebsiella pneumoniae (2112株)
      KPNEUMONIAE: { IPM: 85, MEM: 88, ETP: 82, CAZ: 60, CTX: 59, FEP: 81, TZP: 64, CZA: 78, CTT: 9, AN: 92, GM: 67, CIP: 65, LVX: 48, SXT: 53, TGC: 84, CL: 0, SAM: 44 },
      
      // Enterobacter cloacae complex (478株)
      ENTCLOACAE: { IPM: 88, MEM: 91, ETP: 79, CAZ: 40, CTX: 37, FEP: 62, TZP: 42, CZA: 55, CTT: 18, AN: 84, GM: 84, CIP: 61, LVX: 58, SXT: 57, TGC: 76, CL: 0, SAM: 0 },
      
      // Proteus mirabilis (459株)
      PROTMIRABILIS: { MEM: 100, ETP: 100, CAZ: 92, CTX: 80, FEP: 96, TZP: 98, AN: 97, GM: 71, CIP: 74, LVX: 74, SXT: 52, SAM: 71 },
      
      // Serratia marcescens (294株)
      SERMARCESCENS: { MEM: 87, ETP: 80, CAZ: 58, CTX: 53, FEP: 66, TZP: 64, CZA: 0, AN: 73, GM: 72, CIP: 60, LVX: 60, SXT: 72, TGC: 59, SAM: 0 },
      
      // Klebsiella aerogenes (179株)
      KAEROGENES: { IPM: 84, MEM: 96, ETP: 90, CAZ: 59, CTX: 51, FEP: 92, TZP: 50, AN: 93, GM: 91, CIP: 78, LVX: 66, SXT: 89, TGC: 88, CL: 0, SAM: 1 },
      
      // Citrobacter koseri (146株)
      CITKOSERI: { IPM: 98, MEM: 99, ETP: 97, CAZ: 91, CTX: 90, FEP: 97, TZP: 87, AN: 99, GM: 99, CIP: 96, LVX: 95, SXT: 95, TGC: 100 },
      
      // Morganella morganii (125株)
      MORGMORGANII: { MEM: 100, ETP: 100, CAZ: 71, CTX: 70, FEP: 96, TZP: 93, AN: 98, GM: 84, CIP: 73, LVX: 71, SXT: 73, SAM: 6 },
      
      // Klebsiella oxytoca (102株)
      KOXYTOCA: { IPM: 74, MEM: 78, ETP: 78, CAZ: 61, CTX: 55, FEP: 78, TZP: 61, CZA: 14, CTT: 0, AN: 75, GM: 65, CIP: 63, LVX: 59, SXT: 51, TGC: 97, SAM: 48 },
      
      // GNB-NF - 非發酵菌
      // Pseudomonas aeruginosa (2028株)
      PAER: { IPM: 79, MEM: 79, CAZ: 78, FEP: 80, TZP: 68, CZA: 79, CTT: 87, CIP: 78, LVX: 72, TGC: 0, CL: 0 },
      
      // Acinetobacter baumannii (471株)
      ACBBAUMANNII: { IPM: 47, MEM: 47, CAZ: 45, FEP: 47, TZP: 44, GM: 59, CIP: 44, LVX: 46, CL: 0, SAM: 52 },
      
      // Acinetobacter nosocomialis (307株)
      ACBNOSOCOMIALIS: { IPM: 73, MEM: 73, CAZ: 72, FEP: 76, TZP: 71, GM: 75, CIP: 73, LVX: 74, CL: 0, SAM: 93 },
      
      // Stenotrophomonas maltophilia (709株)
      STEMALTOPHILIA: { LVX: 74, SXT: 79 },
      
      // Chryseobacterium indologenes (256株)
      CHRYSINDOLOGENES: { IPM: 4, MEM: 4, CAZ: 1, FEP: 6, TZP: 2, AN: 0, GM: 0, CIP: 20, LVX: 24 },
      
      // Burkholderia cepacia complex (250株)
      BURKCOMPLEX: { MEM: 71, CAZ: 85, LVX: 30, SXT: 77 },
      
      // Elizabethkingia anophelis (116株)
      ELIZANOPHELIS: { IPM: 3, MEM: 3, CAZ: 0, FEP: 5, TZP: 3, AN: 2, GM: 1, CIP: 70, LVX: 82 },
      
      // GNC - 革蘭氏陰性球菌
      // Moraxella catarrhalis (177株)
      MORAXCATARRHALIS: { CTX: 96, SXT: 35 },
      
      // Haemophilus influenzae (136株)
      HAEMINFLUENZAE: { CTX: 96, SXT: 35 }
    };

    // 可選：若提供 I/S/R 類別，可優先用它判斷是否為 S
    const catStatus = {
      // 例如：ECOLI: { IPM: "S" }
    };

    function Preview(){
      return (
        <ASTSusceptibilityTable
          antibiotics={antibioticsFromExcel}
          microbes={microbesFromTest}
          data={excelData}
          cat={catStatus}
        />
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Preview />);
  </script>
</body>
</html>
